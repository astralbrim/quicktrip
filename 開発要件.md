# ちょいでかけ (QuickTrip) 開発要件書

## 1. 技術スタック

### フロントエンド (apps/web)
- **Framework**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS + shadcn/ui
- **認証**: NextAuth.js (Email/Password + Google/GitHub)
- **地図表示**: Leaflet + React Leaflet
- **状態管理**: Zustand
- **データフェッチ**: TanStack Query
- **フォーム**: React Hook Form + Zod
- **デプロイ**: Vercel

### バックエンド (apps/api)
- **Framework**: Hono
- **ランタイム**: Cloudflare Workers
- **データベース**: Cloudflare D1
- **ORM**: Prisma + @prisma/adapter-d1
- **バリデーション**: Zod
- **認証**: JWT (jose library)
- **デプロイ**: Cloudflare Workers

### 共通
- **モノレポ管理**: Turborepo
- **パッケージマネージャー**: pnpm
- **コード品質**: ESLint + Prettier
- **Git**: GitHub
- **型共有**: 手動エクスポート → 将来的にtRPC検討

### 外部API
- **地図タイル**: OpenStreetMap
- **ジオコーディング**: Nominatim API
- **ルート検索**: OpenRouteService API
- **場所データ**: Overpass API (OpenStreetMap)

## 2. プロジェクト構造

```
quicktrip/
├── apps/
│   ├── web/                    # Next.js フロントエンド
│   │   ├── app/               # App Router
│   │   │   ├── (auth)/       # 認証関連ページ
│   │   │   ├── (main)/       # メインアプリ
│   │   │   ├── api/          # NextAuth API
│   │   │   └── layout.tsx
│   │   ├── components/        # UIコンポーネント
│   │   │   ├── ui/          # shadcn/ui
│   │   │   ├── map/         # 地図関連
│   │   │   └── layout/      # レイアウト
│   │   ├── hooks/            # カスタムフック
│   │   ├── lib/              # ユーティリティ
│   │   │   ├── auth.ts      # NextAuth設定
│   │   │   └── api-client.ts # API通信
│   │   ├── stores/           # Zustand stores
│   │   └── types/            # 型定義
│   │
│   └── api/                   # Hono バックエンド
│       ├── src/
│       │   ├── index.ts      # エントリーポイント
│       │   ├── routes/       # APIルート
│       │   │   ├── auth.ts
│       │   │   ├── places.ts
│       │   │   └── users.ts
│       │   ├── middleware/   # 認証等
│       │   ├── services/     # ビジネスロジック
│       │   └── utils/        # ユーティリティ
│       ├── prisma/
│       │   └── schema.prisma
│       └── wrangler.toml     # Cloudflare設定
│
├── packages/
│   └── shared/               # 共有パッケージ
│       ├── src/
│       │   ├── types/       # 共通型定義
│       │   │   ├── place.ts
│       │   │   ├── user.ts
│       │   │   └── api.ts
│       │   └── constants/   # 定数
│       └── package.json
│
├── turbo.json               # Turborepo設定
├── pnpm-workspace.yaml      # pnpmワークスペース
├── .gitignore
├── .eslintrc.js            # ESLint設定（ルート）
├── prettier.config.js       # Prettier設定
└── README.md

```

## 3. データベース設計（Prisma Schema）

```prisma
// apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // ソーシャルログインの場合null
  name          String?
  provider      String?   // google, github, email
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  searchHistories SearchHistory[]
  favorites       Favorite[]
}

model SearchHistory {
  id            String    @id @default(cuid())
  userId        String
  timeMinutes   Int       // 検索時間（分）
  transport     String    // walk, train, car, bus
  latitude      Float
  longitude     Float
  address       String?
  filters       String?   // JSON文字列として保存
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id])
  
  @@index([userId, createdAt])
}

model Favorite {
  id            String    @id @default(cuid())
  userId        String
  placeId       String    // OpenStreetMap ID
  placeName     String
  category      String
  latitude      Float
  longitude     Float
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id])
  
  @@unique([userId, placeId])
  @@index([userId])
}
```

## 4. 環境変数

### apps/web/.env.local
```env
# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key

# OAuth Providers
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=

# API
NEXT_PUBLIC_API_URL=http://localhost:8787
```

### apps/api/.dev.vars
```env
# JWT Secret (same as NEXTAUTH_SECRET)
JWT_SECRET=your-secret-key

# External APIs
OPENROUTESERVICE_API_KEY=
```

## 5. MVP機能スコープ

### Phase 1 (1週間目標)
1. **認証機能**
   - ユーザー登録（メール/パスワード）
   - ログイン/ログアウト
   - Googleログイン

2. **基本的な地図機能**
   - 現在地取得・表示
   - 地図上に現在地から30分圏内の観光スポット表示
   - スポットクリックで基本情報表示

3. **検索履歴**
   - 検索実行時に履歴保存
   - 履歴一覧表示（最新5件）

### Phase 2 (2週間目標)
- 時間・移動手段の変更機能
- カテゴリーフィルター
- リスト表示切り替え
- 詳細フィルター機能

### Phase 3 (3週間目標)
- お気に入り機能
- 住所検索
- レスポンシブ最適化
- PWA対応

## 6. 開発手順

### Step 1: 初期セットアップ
```bash
# 1. モノレポの作成
pnpm create turbo@latest quicktrip

# 2. 依存関係のインストール
cd quicktrip
pnpm install

# 3. Cloudflare CLIのインストール
pnpm add -g wrangler
```

### Step 2: バックエンド構築
1. Hono + Cloudflare Workersのセットアップ
2. D1データベースの作成
3. Prismaの設定
4. 認証APIの実装

### Step 3: フロントエンド構築
1. Next.js + NextAuthのセットアップ
2. 地図コンポーネントの実装
3. API連携
4. UI実装

## 7. デプロイ設定

### Vercel (Frontend)
- GitHubリポジトリと連携
- Root Directory: `apps/web`
- Build Command: `pnpm build`
- Output Directory: `.